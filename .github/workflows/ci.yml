name: CI

on:
    push:
        branches:
            - main
            - pre
            - develop
    pull_request: {}

# Needed for nx-set-shas when run on the main branch
permissions:
    actions: read
    contents: read

jobs:
    main:
        runs-on: ubuntu-latest
        env:
            NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
            NX_NO_CLOUD: ${{ vars.NX_NO_CLOUD }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  filter: tree:0
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.19.0

            - name: Setup Nodejs
              uses: actions/setup-node@v4
              with:
                  node-version: 22.21.0
                  # Cache node_modules
                  cache: "pnpm"

            - name: Set Nx SHA
              uses: nrwl/nx-set-shas@v4

            # This enables task distribution via Nx Cloud
            # Run this command as early as possible, before dependencies are installed
            # Learn more at https://nx.dev/ci/reference/nx-cloud-cli#npx-nxcloud-startcirun
            - name: Start Nx Cloud CI Run
              run: pnpm dlx nx-cloud start-ci-run --distribute-on="3 linux-medium-js" --stop-agents-after="build"

            - name: Restore cached npm dependencies
              id: cache-dependencies-restore
              uses: actions/cache/restore@v4
              with:
                  path: |
                      node_modules
                      ~/.cache/Cypress # needed for the Cypress binary
                  key: npm-dependencies-${{ runner.os }}-${{ github.ref_name }}-${{ hashFiles('pnpm-lock.yaml') }}
                  restore-keys: |
                      npm-dependencies-${{ runner.os }}-${{ github.ref_name }}-
                      npm-dependencies-${{ runner.os }}-main-
                      npm-dependencies-${{ runner.os }}-develop-
                      npm-dependencies-${{ runner.os }}-

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Cache npm dependencies
              id: cache-dependencies-save
              uses: actions/cache/save@v4
              with:
                  path: |
                      node_modules
                      ~/.cache/Cypress # needed for the Cypress binary
                  key: ${{ steps.cache-dependencies-restore.outputs.cache-primary-key }}

            - name: Restore Stryker incremental cache
              id: cache-stryker-restore
              uses: actions/cache/restore@v4
              with:
                  path: packages/*/reports/stryker-incremental.json
                  key: stryker-${{ runner.os }}-${{ github.ref_name }}-${{ hashFiles('pnpm-lock.yaml') }}
                  restore-keys: |
                      stryker-${{ runner.os }}-${{ github.ref_name }}-
                      stryker-${{ runner.os }}-develop-
                      stryker-${{ runner.os }}-

            - name: ğŸ” Check monorepo integrity
              run: pnpm exec nx sync:check

            - name: ğŸ” Check exports from packages
              run: pnpm exec nx run-many -t build:check-exports

            - name: ğŸ” Check for format and lint configs are valid
              run: pnpm exec nx run-many -t lint:eslint:config-check lint:stylelint:config-check:scss

            - name: ğŸ” Execute lint checks for affected files (Affected)
              run: pnpm exec nx affected -t lint:eslint lint:stylelint lint:markdownlint lint:prettier && pnpm run lint:knip
              if: ${{ github.event_name == 'pull_request' }}

            - name: ğŸ” Execute lint checks for all files (All)
              run: pnpm exec nx run-many -t lint:publint lint:knip lint:eslint lint:stylelint lint:markdownlint lint:prettier
              if: ${{ github.event_name == 'push' }}

            - name: ğŸ§ª Execute test checks for affected files (Affected)
              # We disable the coverage threshold for PRs because affected will only run on the files
              # that have changed and the coverage will be lower than the threshold
              run: pnpm exec nx affected -t test:unit:coverage -- --coverage.thresholds.0
              if: ${{ github.event_name == 'pull_request' }}

            - name: ğŸ§ª Execute test checks for all files (All)
              run: pnpm exec nx run-many -t test:unit:coverage
              if: ${{ github.event_name == 'push' }}

            # Upload coverage per package with individual flags for isolated tracking
            - name: ğŸ“Š Upload coverage to Codecov - react-hooks
              uses: codecov/codecov-action@v5
              with:
                  files: ./packages/react-hooks/coverage/lcov.info
                  flags: react-hooks
                  token: ${{ secrets.CODECOV_TOKEN }}
                  fail_ci_if_error: false

            - name: ğŸ“Š Upload coverage to Codecov - react-clean
              uses: codecov/codecov-action@v5
              with:
                  files: ./packages/react-clean/coverage/lcov.info
                  flags: react-clean
                  token: ${{ secrets.CODECOV_TOKEN }}
                  fail_ci_if_error: false

            - name: ğŸ“Š Upload coverage to Codecov - is-even
              uses: codecov/codecov-action@v5
              with:
                  files: ./packages/is-even/coverage/lcov.info
                  flags: is-even
                  token: ${{ secrets.CODECOV_TOKEN }}
                  fail_ci_if_error: false

            - name: ğŸ“Š Upload coverage to Codecov - is-odd
              uses: codecov/codecov-action@v5
              with:
                  files: ./packages/is-odd/coverage/lcov.info
                  flags: is-odd
                  token: ${{ secrets.CODECOV_TOKEN }}
                  fail_ci_if_error: false

            - name: ğŸ“Š Upload coverage to Codecov - ts-configs
              uses: codecov/codecov-action@v5
              with:
                  files: ./packages/ts-configs/coverage/lcov.info
                  flags: ts-configs
                  token: ${{ secrets.CODECOV_TOKEN }}
                  fail_ci_if_error: false

            # Upload test results per package with individual flags
            - name: ğŸ“Š Upload test results to Codecov - react-hooks
              uses: codecov/test-results-action@v1
              if: ${{ !cancelled() }}
              with:
                  files: ./packages/react-hooks/test-results.junit.xml
                  token: ${{ secrets.CODECOV_TOKEN }}
                  flags: react-hooks

            - name: ğŸ“Š Upload test results to Codecov - react-clean
              uses: codecov/test-results-action@v1
              if: ${{ !cancelled() }}
              with:
                  files: ./packages/react-clean/test-results.junit.xml
                  token: ${{ secrets.CODECOV_TOKEN }}
                  flags: react-clean

            - name: ğŸ“Š Upload test results to Codecov - is-even
              uses: codecov/test-results-action@v1
              if: ${{ !cancelled() }}
              with:
                  files: ./packages/is-even/test-results.junit.xml
                  token: ${{ secrets.CODECOV_TOKEN }}
                  flags: is-even

            - name: ğŸ“Š Upload test results to Codecov - is-odd
              uses: codecov/test-results-action@v1
              if: ${{ !cancelled() }}
              with:
                  files: ./packages/is-odd/test-results.junit.xml
                  token: ${{ secrets.CODECOV_TOKEN }}
                  flags: is-odd

            - name: ğŸ“Š Upload test results to Codecov - ts-configs
              uses: codecov/test-results-action@v1
              if: ${{ !cancelled() }}
              with:
                  files: ./packages/ts-configs/test-results.junit.xml
                  token: ${{ secrets.CODECOV_TOKEN }}
                  flags: ts-configs

            - name: ğŸ— Execute build checks for affected files (Affected)
              run: pnpm exec nx affected -t build
              if: ${{ github.event_name == 'pull_request' }}

            - name: ğŸ— Execute build checks for all files (All)
              run: pnpm exec nx run-many -t build
              if: ${{ github.event_name == 'push' }}

            - name: ğŸ§¬ Execute mutation testing (All)
              run: pnpm exec nx run-many -t test:mutation
              if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
              env:
                  STRYKER_DASHBOARD_API_KEY: ${{ secrets.STRYKER_DASHBOARD_API_KEY }}

            - name: Cache Stryker incremental results
              id: cache-stryker-save
              uses: actions/cache/save@v4
              if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
              with:
                  path: packages/*/reports/stryker-incremental.json
                  key: ${{ steps.cache-stryker-restore.outputs.cache-primary-key }}

            - name: ğŸ“Š Upload mutation reports as artifacts
              uses: actions/upload-artifact@v4
              if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
              with:
                  name: mutation-reports
                  path: packages/*/reports/mutation
                  retention-days: 30

            - name: ğŸ“¦ Analyze and upload bundle sizes to Codecov
              continue-on-error: true
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
              run: |
                  # Analyze each published package
                  for package in react-hooks react-clean is-even is-odd ts-configs; do
                    if [ -d "packages/$package/dist" ]; then
                      echo "Analyzing bundle for $package..."
                      pnpm exec bundle-analyzer packages/$package/dist \
                        --bundle-name="$package" \
                        --upload-token="$CODECOV_TOKEN"
                    else
                      echo "Skipping $package: dist directory not found"
                    fi
                  done
