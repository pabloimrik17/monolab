name: CI

on:
    push:
        branches:
            - main
            - pre
            - develop
    pull_request: {}

# Needed for nx-set-shas when run on the main branch
permissions:
    actions: read
    contents: read

jobs:
    main:
        runs-on: ubuntu-latest
        env:
            NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
            # Set to 'true' to disable Nx Cloud when monthly limit is reached
            NX_NO_CLOUD: ${{ vars.NX_NO_CLOUD }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  filter: tree:0
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.19.0

            - name: Setup Nodejs
              uses: actions/setup-node@v4
              with:
                  node-version: 22.21.0
                  # Cache node_modules
                  cache: "pnpm"

            - name: Set Nx SHA
              uses: nrwl/nx-set-shas@v4

            - name: Debug Nx Cloud variable
              run: |
                  echo "NX_NO_CLOUD variable: '${{ vars.NX_NO_CLOUD }}'"
                  echo "NX_NO_CLOUD env: '${{ env.NX_NO_CLOUD }}'"

            # This enables task distribution via Nx Cloud
            # Run this command as early as possible, before dependencies are installed
            # Learn more at https://nx.dev/ci/reference/nx-cloud-cli#npx-nxcloud-startcirun
            - name: Start Nx Cloud CI Run
              if: ${{ env.NX_NO_CLOUD != 'true' }}
              run: pnpm dlx nx-cloud start-ci-run --distribute-on="3 linux-medium-js" --stop-agents-after="build"

            - name: Restore cached npm dependencies
              id: cache-dependencies-restore
              uses: actions/cache/restore@v4
              with:
                  path: |
                      node_modules
                      ~/.cache/Cypress # needed for the Cypress binary
                  key: npm-dependencies-${{ runner.os }}-${{ github.ref_name }}-${{ hashFiles('pnpm-lock.yaml') }}
                  restore-keys: |
                      npm-dependencies-${{ runner.os }}-${{ github.ref_name }}-
                      npm-dependencies-${{ runner.os }}-main-
                      npm-dependencies-${{ runner.os }}-develop-
                      npm-dependencies-${{ runner.os }}-

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Cache npm dependencies
              id: cache-dependencies-save
              uses: actions/cache/save@v4
              with:
                  path: |
                      node_modules
                      ~/.cache/Cypress # needed for the Cypress binary
                  key: ${{ steps.cache-dependencies-restore.outputs.cache-primary-key }}

            - name: Restore Stryker incremental cache
              id: cache-stryker-restore
              uses: actions/cache/restore@v4
              with:
                  path: packages/*/reports/stryker-incremental.json
                  key: stryker-${{ runner.os }}-${{ github.ref_name }}-${{ hashFiles('pnpm-lock.yaml') }}
                  restore-keys: |
                      stryker-${{ runner.os }}-${{ github.ref_name }}-
                      stryker-${{ runner.os }}-develop-
                      stryker-${{ runner.os }}-

            - name: üîç Check monorepo integrity
              run: pnpm exec nx sync:check

            - name: üîç Check exports from packages
              run: pnpm exec nx run-many -t build:check-exports

            - name: üîç Check for format and lint configs are valid
              run: pnpm exec nx run-many -t lint:eslint:config-check lint:stylelint:config-check:scss

            - name: üîç Execute lint checks for affected files (Affected)
              run: pnpm exec nx affected -t lint:eslint lint:stylelint lint:markdownlint lint:prettier && pnpm run lint:knip
              if: ${{ github.event_name == 'pull_request' }}

            - name: üîç Execute lint checks for all files (All)
              run: pnpm exec nx run-many -t lint:publint lint:knip lint:eslint lint:stylelint lint:markdownlint lint:prettier
              if: ${{ github.event_name == 'push' }}

            - name: üß™ Execute test checks for affected files (Affected)
              # We disable the coverage threshold for PRs because affected will only run on the files
              # that have changed and the coverage will be lower than the threshold
              run: pnpm exec nx affected -t test:unit:coverage -- --coverage.thresholds.0
              if: ${{ github.event_name == 'pull_request' }}

            - name: üß™ Execute test checks for all files (All)
              run: pnpm exec nx run-many -t test:unit:coverage
              if: ${{ github.event_name == 'push' }}

            # Detect which packages are affected by PR changes for conditional Codecov uploads
            # This step only runs on PRs to optimize upload time and API usage
            - name: üîç Detect affected packages for Codecov
              id: affected-codecov
              if: ${{ github.event_name == 'pull_request' }}
              run: |
                  # Get list of affected projects from Nx
                  AFFECTED_PROJECTS=$(pnpm exec nx show projects --affected)
                  echo "Affected projects:"
                  echo "$AFFECTED_PROJECTS"

                  # Check each package and set boolean output
                  for package in react-hooks react-clean is-even is-odd ts-configs; do
                    if echo "$AFFECTED_PROJECTS" | grep -q "@monolab/$package"; then
                      echo "$package=true" >> $GITHUB_OUTPUT
                      echo "‚úì $package is affected"
                    else
                      echo "$package=false" >> $GITHUB_OUTPUT
                      echo "‚è≠Ô∏è  $package is not affected"
                    fi
                  done

            # Upload coverage per package with individual flags for isolated tracking
            # In PRs: only upload affected packages. On main/develop/pre: upload all packages for baseline
            - name: üìä Upload coverage to Codecov (affected packages)
              if: ${{ !cancelled() }}
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
                  IS_PR: ${{ github.event_name == 'pull_request' }}
                  AFFECTED_REACT_HOOKS: ${{ steps.affected-codecov.outputs.react-hooks }}
                  AFFECTED_REACT_CLEAN: ${{ steps.affected-codecov.outputs.react-clean }}
                  AFFECTED_IS_EVEN: ${{ steps.affected-codecov.outputs.is-even }}
                  AFFECTED_IS_ODD: ${{ steps.affected-codecov.outputs.is-odd }}
                  AFFECTED_TS_CONFIGS: ${{ steps.affected-codecov.outputs.ts-configs }}
              run: |
                  # Map package names to affected status for conditional uploads
                  declare -A affected=(
                    ["react-hooks"]="$AFFECTED_REACT_HOOKS"
                    ["react-clean"]="$AFFECTED_REACT_CLEAN"
                    ["is-even"]="$AFFECTED_IS_EVEN"
                    ["is-odd"]="$AFFECTED_IS_ODD"
                    ["ts-configs"]="$AFFECTED_TS_CONFIGS"
                  )

                  uploaded=0
                  skipped=0

                  # Process each package
                  for package in react-hooks react-clean is-even is-odd ts-configs; do
                    coverage_file="./packages/$package/coverage/lcov.info"

                    # Determine if we should upload this package
                    should_upload=false
                    if [[ "$IS_PR" != "true" ]]; then
                      # Push to main/develop/pre: always upload all packages to establish baseline
                      should_upload=true
                    elif [[ "${affected[$package]}" == "true" ]]; then
                      # PR with affected package: upload
                      should_upload=true
                    fi

                    if [[ "$should_upload" == "true" ]]; then
                      if [[ -f "$coverage_file" ]]; then
                        echo "üìä Uploading coverage for $package..."
                        npx codecov@latest upload-process \
                          --file="$coverage_file" \
                          --flag="$package" \
                          --token="$CODECOV_TOKEN" \
                          --fail-on-error=false
                        ((uploaded++))
                      else
                        echo "‚ö†Ô∏è  Coverage file not found for $package: $coverage_file"
                      fi
                    else
                      echo "‚è≠Ô∏è  Skipping $package (not affected)"
                      ((skipped++))
                    fi
                  done

                  echo "‚úÖ Coverage upload complete: $uploaded uploaded, $skipped skipped"

            # Upload test results per package with individual flags
            # Critical: runs even if tests fail (via !cancelled()) to capture failure data for Test Analytics
            # In PRs: only upload affected packages. On main/develop/pre: upload all packages for baseline
            - name: üìä Upload test results to Codecov (affected packages)
              if: ${{ !cancelled() }}
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
                  IS_PR: ${{ github.event_name == 'pull_request' }}
                  AFFECTED_REACT_HOOKS: ${{ steps.affected-codecov.outputs.react-hooks }}
                  AFFECTED_REACT_CLEAN: ${{ steps.affected-codecov.outputs.react-clean }}
                  AFFECTED_IS_EVEN: ${{ steps.affected-codecov.outputs.is-even }}
                  AFFECTED_IS_ODD: ${{ steps.affected-codecov.outputs.is-odd }}
                  AFFECTED_TS_CONFIGS: ${{ steps.affected-codecov.outputs.ts-configs }}
              run: |
                  # Map package names to affected status for conditional uploads
                  declare -A affected=(
                    ["react-hooks"]="$AFFECTED_REACT_HOOKS"
                    ["react-clean"]="$AFFECTED_REACT_CLEAN"
                    ["is-even"]="$AFFECTED_IS_EVEN"
                    ["is-odd"]="$AFFECTED_IS_ODD"
                    ["ts-configs"]="$AFFECTED_TS_CONFIGS"
                  )

                  uploaded=0
                  skipped=0

                  # Process each package
                  for package in react-hooks react-clean is-even is-odd ts-configs; do
                    test_results_file="./packages/$package/test-results.junit.xml"

                    # Determine if we should upload this package
                    should_upload=false
                    if [[ "$IS_PR" != "true" ]]; then
                      # Push to main/develop/pre: always upload all packages to establish baseline
                      should_upload=true
                    elif [[ "${affected[$package]}" == "true" ]]; then
                      # PR with affected package: upload
                      should_upload=true
                    fi

                    if [[ "$should_upload" == "true" ]]; then
                      if [[ -f "$test_results_file" ]]; then
                        echo "üìä Uploading test results for $package..."
                        npx codecov@latest upload-test-results \
                          --file="$test_results_file" \
                          --flag="$package" \
                          --token="$CODECOV_TOKEN" \
                          --fail-on-error=false
                        ((uploaded++))
                      else
                        echo "‚ö†Ô∏è  Test results file not found for $package: $test_results_file"
                      fi
                    else
                      echo "‚è≠Ô∏è  Skipping $package (not affected)"
                      ((skipped++))
                    fi
                  done

                  echo "‚úÖ Test results upload complete: $uploaded uploaded, $skipped skipped"

            - name: üèó Execute build checks for affected files (Affected)
              run: pnpm exec nx affected -t build
              if: ${{ github.event_name == 'pull_request' }}

            - name: üèó Execute build checks for all files (All)
              run: pnpm exec nx run-many -t build
              if: ${{ github.event_name == 'push' }}

            - name: üß¨ Execute mutation testing (All)
              run: pnpm exec nx run-many -t test:mutation
              if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
              env:
                  STRYKER_DASHBOARD_API_KEY: ${{ secrets.STRYKER_DASHBOARD_API_KEY }}

            - name: Cache Stryker incremental results
              id: cache-stryker-save
              uses: actions/cache/save@v4
              if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
              with:
                  path: packages/*/reports/stryker-incremental.json
                  key: ${{ steps.cache-stryker-restore.outputs.cache-primary-key }}

            - name: üìä Upload mutation reports as artifacts
              uses: actions/upload-artifact@v4
              if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
              with:
                  name: mutation-reports
                  path: packages/*/reports/mutation
                  retention-days: 30

            - name: üì¶ Analyze and upload bundle sizes to Codecov
              continue-on-error: true
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
                  IS_PR: ${{ github.event_name == 'pull_request' }}
                  AFFECTED_REACT_HOOKS: ${{ steps.affected-codecov.outputs.react-hooks }}
                  AFFECTED_REACT_CLEAN: ${{ steps.affected-codecov.outputs.react-clean }}
                  AFFECTED_IS_EVEN: ${{ steps.affected-codecov.outputs.is-even }}
                  AFFECTED_IS_ODD: ${{ steps.affected-codecov.outputs.is-odd }}
                  AFFECTED_TS_CONFIGS: ${{ steps.affected-codecov.outputs.ts-configs }}
              run: |
                  # Map package names to affected status for conditional uploads
                  declare -A affected=(
                    ["react-hooks"]="$AFFECTED_REACT_HOOKS"
                    ["react-clean"]="$AFFECTED_REACT_CLEAN"
                    ["is-even"]="$AFFECTED_IS_EVEN"
                    ["is-odd"]="$AFFECTED_IS_ODD"
                    ["ts-configs"]="$AFFECTED_TS_CONFIGS"
                  )

                  uploaded=0
                  skipped=0

                  # Analyze each published package
                  for package in react-hooks react-clean is-even is-odd ts-configs; do
                    # Determine if we should upload this package
                    should_upload=false
                    if [[ "$IS_PR" != "true" ]]; then
                      # Push to main/develop/pre: always upload all packages to establish baseline
                      should_upload=true
                    elif [[ "${affected[$package]}" == "true" ]]; then
                      # PR with affected package: upload
                      should_upload=true
                    fi

                    if [[ "$should_upload" == "true" ]]; then
                      if [ -d "packages/$package/dist" ]; then
                        echo "üì¶ Analyzing bundle for $package..."
                        pnpm exec bundle-analyzer packages/$package/dist \
                          --bundle-name="$package" \
                          --upload-token="$CODECOV_TOKEN"
                        ((uploaded++))
                      else
                        echo "‚ö†Ô∏è  Skipping $package: dist directory not found"
                      fi
                    else
                      echo "‚è≠Ô∏è  Skipping $package (not affected)"
                      ((skipped++))
                    fi
                  done

                  echo "‚úÖ Bundle analysis complete: $uploaded uploaded, $skipped skipped"
