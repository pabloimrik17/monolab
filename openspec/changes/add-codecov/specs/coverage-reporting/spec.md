# Spec: Coverage Reporting

## ADDED Requirements

### Requirement: CI workflow MUST upload coverage reports to Codecov

The GitHub Actions CI workflow MUST automatically upload code coverage reports to Codecov after running tests.

#### Scenario: Upload coverage on pull request runs

**Given** a pull request triggers the CI workflow
**When** affected tests complete with coverage enabled
**Then** the workflow uploads coverage reports from affected packages to Codecov
**And** the upload includes only packages that were tested (affected)
**And** the upload step uses the `CODECOV_TOKEN` secret for authentication
**And** the upload includes flags for automatic package detection (react-hooks, react-clean, is-even, is-odd, ts-configs)

#### Scenario: Upload coverage on main branch push

**Given** code is pushed to the main branch
**When** all tests complete with coverage enabled
**Then** the workflow uploads coverage reports from all packages to Codecov
**And** the upload includes coverage data from all packages in the monorepo
**And** the upload step uses the `CODECOV_TOKEN` secret for authentication
**And** the upload includes flags for automatic package detection (react-hooks, react-clean, is-even, is-odd, ts-configs)
**And** Codecov associates coverage with appropriate flags based on file paths

#### Scenario: Upload coverage on develop and pre branch push

**Given** code is pushed to the develop or pre branch
**When** all tests complete with coverage enabled
**Then** the workflow uploads coverage reports from all packages to Codecov
**And** the upload reflects the branch name in Codecov dashboard

#### Scenario: Flags enable per-package coverage tracking

**Given** coverage reports are uploaded with flags
**When** Codecov processes the upload
**Then** each package's coverage is tracked separately by flag
**And** global coverage aggregates all packages
**And** coverage can be filtered by individual flags in the dashboard
**And** PR comments show coverage changes per affected flag

---

### Requirement: Coverage upload step MUST use lcov format

Codecov upload MUST accept lcov coverage files generated by Vitest.

#### Scenario: Upload multiple lcov files from monorepo

**Given** Vitest has generated coverage reports for multiple packages
**When** the Codecov upload action runs
**Then** it discovers all lcov.info files using glob pattern `packages/*/coverage/lcov.info`
**And** it discovers all lcov.info files using glob pattern `apps/*/coverage/lcov.info`
**And** Codecov merges all coverage reports into a unified view

---

### Requirement: Coverage upload failures MUST NOT block CI

Coverage upload errors MUST NOT prevent successful builds from passing CI.

#### Scenario: Codecov service is unavailable

**Given** the CI workflow completes tests successfully
**When** the Codecov upload step fails due to service unavailability
**Then** the CI workflow continues and does not fail
**And** the overall CI status is "success"
**And** the workflow logs indicate the Codecov upload failure

#### Scenario: Invalid Codecov token

**Given** the `CODECOV_TOKEN` secret is missing or invalid
**When** the Codecov upload step attempts authentication
**Then** the upload fails gracefully
**And** the CI workflow continues and does not fail
**And** the workflow logs indicate the authentication failure

---

### Requirement: Coverage reports MUST include commit and branch metadata

Uploaded coverage reports MUST include git metadata for proper tracking in Codecov.

#### Scenario: Upload includes commit SHA

**Given** a CI workflow runs for a specific commit
**When** coverage is uploaded to Codecov
**Then** the upload includes the full commit SHA
**And** Codecov associates the coverage with that commit

#### Scenario: Upload includes branch name

**Given** a CI workflow runs on a specific branch
**When** coverage is uploaded to Codecov
**Then** the upload includes the branch name
**And** Codecov displays coverage trends per branch

#### Scenario: Upload includes pull request number

**Given** a CI workflow runs for a pull request
**When** coverage is uploaded to Codecov
**Then** the upload includes the pull request number
**And** Codecov associates coverage with that PR for comment generation
