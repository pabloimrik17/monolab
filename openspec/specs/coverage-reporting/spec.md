# coverage-reporting Specification

## Purpose
TBD - created by archiving change add-codecov. Update Purpose after archive.
## Requirements
### Requirement: CI workflow MUST upload coverage reports to Codecov

The GitHub Actions CI workflow MUST automatically upload code coverage reports to Codecov after running tests.

#### Scenario: Upload coverage on pull request runs

**Given** a pull request triggers the CI workflow
**When** affected tests complete with coverage enabled
**Then** the workflow uploads coverage reports from affected packages to Codecov
**And** the upload includes only packages that were tested (affected)
**And** the upload step uses the `CODECOV_TOKEN` secret for authentication
**And** the upload includes flags for automatic package detection (react-hooks, react-clean, is-even, is-odd, ts-configs)

#### Scenario: Upload coverage on main branch push

**Given** code is pushed to the main branch
**When** all tests complete with coverage enabled
**Then** the workflow uploads coverage reports from all packages to Codecov
**And** the upload includes coverage data from all packages in the monorepo
**And** the upload step uses the `CODECOV_TOKEN` secret for authentication
**And** the upload includes flags for automatic package detection (react-hooks, react-clean, is-even, is-odd, ts-configs)
**And** Codecov associates coverage with appropriate flags based on file paths

#### Scenario: Upload coverage on develop and pre branch push

**Given** code is pushed to the develop or pre branch
**When** all tests complete with coverage enabled
**Then** the workflow uploads coverage reports from all packages to Codecov
**And** the upload reflects the branch name in Codecov dashboard

#### Scenario: Flags enable per-package coverage tracking

**Given** coverage reports are uploaded with flags
**When** Codecov processes the upload
**Then** each package's coverage is tracked separately by flag
**And** global coverage aggregates all packages
**And** coverage can be filtered by individual flags in the dashboard
**And** PR comments show coverage changes per affected flag

---

### Requirement: Coverage upload step MUST use lcov format

Codecov upload MUST accept lcov coverage files generated by Vitest.

#### Scenario: Upload multiple lcov files from monorepo

**Given** Vitest has generated coverage reports for multiple packages
**When** the Codecov upload action runs
**Then** it discovers all lcov.info files using glob pattern `packages/*/coverage/lcov.info`
**And** it discovers all lcov.info files using glob pattern `apps/*/coverage/lcov.info`
**And** Codecov merges all coverage reports into a unified view

---

### Requirement: Coverage upload failures MUST NOT block CI

Coverage upload errors MUST NOT prevent successful builds from passing CI.

#### Scenario: Codecov service is unavailable

**Given** the CI workflow completes tests successfully
**When** the Codecov upload step fails due to service unavailability
**Then** the CI workflow continues and does not fail
**And** the overall CI status is "success"
**And** the workflow logs indicate the Codecov upload failure

#### Scenario: Invalid Codecov token

**Given** the `CODECOV_TOKEN` secret is missing or invalid
**When** the Codecov upload step attempts authentication
**Then** the upload fails gracefully
**And** the CI workflow continues and does not fail
**And** the workflow logs indicate the authentication failure

---

### Requirement: Coverage reports MUST include commit and branch metadata

Uploaded coverage reports MUST include git metadata for proper tracking in Codecov.

#### Scenario: Upload includes commit SHA

**Given** a CI workflow runs for a specific commit
**When** coverage is uploaded to Codecov
**Then** the upload includes the full commit SHA
**And** Codecov associates the coverage with that commit

#### Scenario: Upload includes branch name

**Given** a CI workflow runs on a specific branch
**When** coverage is uploaded to Codecov
**Then** the upload includes the branch name
**And** Codecov displays coverage trends per branch

#### Scenario: Upload includes pull request number

**Given** a CI workflow runs for a pull request
**When** coverage is uploaded to Codecov
**Then** the upload includes the pull request number
**And** Codecov associates coverage with that PR for comment generation

### Requirement: CI workflow MUST use Nx affected detection for coverage uploads

The GitHub Actions CI workflow MUST query Nx to determine which packages are affected before uploading coverage, ensuring only relevant packages upload data on pull requests while maintaining complete baselines on protected branches.

#### Scenario: Detection step runs on pull requests

**Given** a pull request triggers the CI workflow
**When** tests complete
**Then** the workflow runs `nx show projects --affected` to determine affected packages
**And** the detection step generates boolean outputs for each package (react-hooks, react-clean, is-even, is-odd, ts-configs)
**And** the outputs indicate "true" for affected packages and "false" for non-affected packages
**And** subsequent upload steps reference these outputs to make upload decisions

#### Scenario: Affected package uploads coverage

**Given** the detection step identified react-hooks as affected
**When** the coverage upload script runs
**Then** the script uploads coverage for react-hooks
**And** the upload uses the package-specific flag "react-hooks"
**And** the upload includes the lcov.info file from packages/react-hooks/coverage/

#### Scenario: Non-affected package skips coverage upload

**Given** the detection step identified is-even as not affected
**When** the coverage upload script runs
**Then** the script skips upload for is-even
**And** the workflow logs indicate "Skipping coverage upload for is-even (not affected by PR)"
**And** Codecov uses carryforward to fill in is-even coverage from the baseline

#### Scenario: Protected branches upload all packages

**Given** code is pushed to main, develop, or pre branch
**When** tests complete
**Then** the detection step is skipped (does not run on pushes)
**And** the coverage upload script uploads all 5 packages unconditionally
**And** this establishes a complete baseline for future PR comparisons

#### Scenario: Shared dependency change affects multiple packages

**Given** a pull request modifies a shared dependency used by react-hooks and react-clean
**When** the detection step runs
**Then** Nx identifies both react-hooks and react-clean as affected
**And** the detection step outputs "true" for both packages
**And** both packages upload coverage
**And** the other 3 packages skip upload

---

### Requirement: Coverage upload script MUST consolidate individual package steps

The coverage upload MUST use a single bash script that loops through packages instead of individual GitHub Actions steps per package.

#### Scenario: Single script uploads multiple affected packages

**Given** react-hooks and is-odd are affected by a pull request
**When** the coverage upload script runs
**Then** the script processes all 5 packages in a loop
**And** uploads coverage for react-hooks and is-odd
**And** skips coverage for react-clean, is-even, and ts-configs
**And** logs a summary: "Uploaded coverage for 2 packages, skipped 3 packages"

#### Scenario: Script uses codecov CLI directly

**Given** the coverage upload script needs to upload a package
**When** the upload executes
**Then** the script uses `npx codecov@latest upload-process` command
**And** passes the coverage file path with `--file` flag
**And** passes the package flag with `--flag` parameter
**And** uses `--fail-on-error=false` for non-blocking uploads
**And** authenticates with `CODECOV_TOKEN` environment variable

#### Scenario: Script reports upload failures gracefully

**Given** the Codecov API is temporarily unavailable
**When** a package coverage upload fails
**Then** the script logs "⚠️ Failed to upload coverage for react-hooks (non-blocking)"
**And** continues processing remaining packages
**And** the CI workflow does not fail
**And** the summary reflects the failure in the count

---

### Requirement: Coverage uploads MUST maintain consistent affected detection with test execution

The affected packages detected for coverage upload MUST be identical to the packages tested by `nx affected -t test:unit`.

#### Scenario: Coverage uploads align with test execution

**Given** `nx affected -t test:unit` ran tests for react-hooks and react-clean
**When** the detection step runs `nx show projects --affected`
**Then** the affected list includes react-hooks and react-clean
**And** coverage exists for those packages (because tests ran)
**And** coverage upload succeeds for both packages
**And** no coverage files exist for non-tested packages

#### Scenario: Nx base SHA is consistent

**Given** the `nx-set-shas` action ran before tests
**When** tests execute with `nx affected`
**Then** Nx uses the determined base SHA
**And** when the detection step runs `nx show projects --affected`
**Then** it uses the same base SHA
**And** both commands return identical affected package lists

